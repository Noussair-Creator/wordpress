<div class="content-wrapper">

    <div class="status-bar-container">
      <div class="status-header">
        <h2>Statut candidature</h2>


        <div class="status-select" id="status-select-dossier">
        <button class="status-button">Statut Dossier</button>
        <div class="status-options">
         
        </div>
      </div>


      </div>
    </div>



    <div class="grid-container" id="dragZone">
  <div class="box" draggable="true">
    <h3>Informations g√©n√©rales</h3>
    <ul>
      <li><strong>CIN :</strong> </li>
      <li><strong>Nom et pr√©nom :</strong> </li>
      <li><strong>E-mail :</strong> </li>
      <li><strong>Sexe :</strong> </li>
      <li><strong>Situation :</strong> </li>
      <li><strong>Derni√®re connexion :</strong> </li>
      <li><strong>Enabled :</strong> <span class="badge enabled"></span></li>
    </ul>
  </div>

  <div class="box" draggable="true">
    <h3>Bac</h3>
    <ul>
      <li><strong>Session :</strong> </li>
      <li><strong>Ann√©e :</strong> </li>
      <li><strong>Mention :</strong> </li>
      <li><strong>Moyenne :</strong> </li>
      <li><strong>Dipl√¥me :</strong>
        <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/PDF_file_icon.svg" alt="PDF" class="pdf-icon">
        Relev√© des notes
        <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/PDF_file_icon.svg" alt="PDF" class="pdf-icon">
      </li>
    </ul>
  </div>

  <div class="box" draggable="true">
    <h3>Adresse</h3>
    <ul>
      <li><strong>Pays :</strong> </li>
      <li><strong>Gouvernorat :</strong> </li>
      <li><strong>Ville :</strong> </li>
      <li><strong>Rue :</strong> /li>
      <li><strong>Code postale :</strong> </li>
    </ul>
  </div>

  <div class="box" draggable="true">
    <h3>Liste des masters en cours</h3>
    <ul>
      <li><strong>Master :</strong> </li>
      <li><strong>√âtablissement :</strong> </li>
      <li><strong>Score :</strong> </li>
      <li><strong>Statut dossier :</strong> </li>
      <li><strong>√âtat de validation :</strong> _</li>
      <li><strong>Statut :</strong> </li>
    </ul>
  </div>
</div>


<!-- Informations th√®se -->
<div class="card full-width">
  <h3>Les informations relatives au dossier de th√®se</h3>
  <ul class="styled-list">
    <li><strong>Type de demande :</strong> R√©inscription ‚Äì 2<sup>e</sup> ann√©e</li>
    <li><strong>Sujet de th√®se :</strong> Optimisation des syst√®mes multi-agents dans les r√©seaux IoT intelligents</li>
    <li><strong>Directeur de th√®se :</strong> Pr. Mourad Ben Said</li>
    <li><strong>Objectif :</strong> D√©velopper un syst√®me intelligent de gestion d‚Äô√©nergie pour les b√¢timents connect√©s‚Ä¶</li>
    <li><strong>Probl√©matique :</strong> La consommation √©nerg√©tique des b√¢timents repr√©sente une part importante‚Ä¶</li>
    <li><strong>R√©sultats attendus :</strong>
      <ul>
        <li>üî∫ Conception d‚Äôun prototype de syst√®me intelligent embarqu√©</li>
        <li>üî∫ R√©duction de 20 √† 30 % de la consommation √©nerg√©tique sur une ann√©e test</li>
        <li>üî∫ Int√©gration avec des capteurs IoT pour suivi en temps r√©el</li>
        <li>üî∫ Publication de r√©sultats dans des revues internationales</li>
        <li>üî∫ D√©p√¥t d‚Äôun brevet en fin de parcours doctoral</li>
      </ul>
    </li>
    <li><strong>M√©thodologie :</strong>
      <ul>
        <li>üî∫ Revue de litt√©rature et analyse comparative</li>
        <li>üî∫ Mod√©lisation des flux via des outils de simulation</li>
        <li>üî∫ D√©veloppement d‚Äôalgorithmes pr√©dictifs (machine learning)</li>
        <li>üî∫ Validation sur d√©monstrateur r√©el (b√¢timent pilote)</li>
        <li>üî∫ √âvaluation environnementale et √©conomique</li>
      </ul>
    </li>
    <li><strong>Mots cl√©s :</strong>
      <span class="badge badge-danger">Intelligence √©nerg√©tique</span>
      <span class="badge badge-danger">Smart Building</span>
      <span class="badge badge-danger">IoT</span>
    </li>
  </ul>
</div>

<!-- Pi√®ces justificatives -->
<div class="card full-width">
  <h3>Pi√®ces justificatives d√©pos√©es</h3>
  <table class="parcours-table">
    <thead>
      <tr>
        <th>Ref_Doc</th>
        <th>Document</th>
        <th>Statut</th>
        <th>T√©l√©charger</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>001</td><td>Formulaire r√©inscription PDF</td><td>Re√ßu</td>
        <td><a href="#"><img class="pdf-icon" src="https://upload.wikimedia.org/wikipedia/commons/8/87/PDF_file_icon.svg" /></a></td>
      </tr>
      <tr>
        <td>002</td><td>Lettre de motivation</td><td>Re√ßu</td>
        <td><a href="#"><img class="pdf-icon" src="https://upload.wikimedia.org/wikipedia/commons/8/87/PDF_file_icon.svg" /></a></td>
      </tr>
      <tr>
        <td>003</td><td>Copie CIN</td><td>Manquant</td>
        <td>‚Äî</td>
      </tr>
      <tr>
        <td>004</td><td>Dipl√¥mes</td><td>Re√ßu</td>
        <td><a href="#"><img class="pdf-icon" src="https://upload.wikimedia.org/wikipedia/commons/8/87/PDF_file_icon.svg" /></a></td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Historique -->
<div class="card full-width">
  <h3>Historique des inscriptions</h3>
  <table class="parcours-table">
    <tbody>
      <tr>
        <td><strong>2023 ‚Äì 2024</strong></td>
        <td>Inscription Valid√©e (1 ≥·µâ Ann√©e)</td>
      </tr>
      <tr>
        <td><strong>2024 ‚Äì 2025</strong></td>
        <td>R√©inscription Demand√©e (2·µâ Ann√©e) ‚Äì En Cours</td>
      </tr>
    </tbody>
  </table>
</div>


  <!-- Parcours universitaire -->
  <div class="card full-width">
    <h3>Parcours universitaire</h3>
    <table class="parcours-table">
      <thead>
        <tr>
          <th>Ann√©e</th>
          <th>Universit√©</th>
          <th>√âtablissement</th>
          <th>Session</th>
          <th>Niveau</th>
          <th>Mention</th>
          <th>Moyenne</th>
          <th>Cr√©dit</th>
          <th>Attestation de r√©ussite</th>
          <th>Relev√© des notes</th>
        </tr>
      </thead>
           <tbody id="parcoursTbody">
            <!-- Parcours sera inject√© ici -->
          </tbody>


          <!--<tbody>
                    <tr>
                      <td>2023/2024</td><td>FST</td><td>Chimie Fine</td><td>Licence Nationale</td><td>3</td><td>Principale</td><td>11</td><td class="notes-cell">
              <div><strong>MGSP</strong> = 15.76</div>
              <div><strong>NC</strong> = 60</div>
            </td>
            <td>‚Äî</td>
                    </tr>
                    <tr>
                      <td>2022/2023</td><td>FST</td><td>Chimie Fine</td><td>Licence Nationale</td><td>2</td><td>Rattrapage</td><td>‚Äî</td><td class="notes-cell">
              <div><strong>MGSP</strong> = 15.76</div>
              <div><strong>NC</strong> = 60</div>
            </td>
            <td>‚Äî</td>
                    </tr>
                    <tr>
                      <td>2021/2022</td><td>FST</td><td>Chimie Fine</td><td>Licence Nationale</td><td>1</td><td>Principale</td><td>‚Äî</td><td class="notes-cell">
              <div><strong>MGSP</strong> = 15.76</div>
              <div><strong>NC</strong> = 60</div>
            </td>
            <td>‚Äî</td>
                    </tr>
          </tbody>-->


    </table>
  </div>
</div>


<style>
  .content-wrapper {
  padding: 20px;
  font-family: 'Poppins', sans-serif;
}

.header-section {
  margin-bottom: 20px;
}

.header-section h2 {
  font-size: 22px;
  font-weight: 600;
}

.grid-layout {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.card {
  background: #fff;
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 0 4px rgba(0, 0, 0, 0.05);
}

.card h3 {
 font-size: 21px;
    margin-bottom: 14px;
    font-weight: 600;
    border-bottom: 1px solid #eee;
    padding-bottom: 6px;
    box-shadow: 0px 5px 16px #00000012;
    margin-left: -23px;
    margin-right: -22px;
    margin-top: -19px;
    padding: 17px 25px;
}

.info-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.info-list li {
  margin-bottom: 8px;
  font-size: 14px;
}

.enabled {
  background: #9EB08F;
  color: #fff;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 13px;
}

.full-width {
  grid-column: 1 / -1;
}

.parcours-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

.parcours-table th,
.parcours-table td {
  border: 1px solid #ddd;
  padding: 8px;
  font-size: 13px;
  text-align: center;
}

.parcours-table th {
  background-color: #f5f5f5;
  font-weight: 600;
}

.pdf-icon {
  width: 16px;
  vertical-align: middle;
  margin-left: 4px;
}
.status-bar-container {
  background-color: #fff;
  border-radius: 8px;
  padding: 16px 24px;
  margin-bottom: 24px;
  font-family: 'Poppins', sans-serif;
  box-shadow: 0px 3px 16px #00000014;
}

.status-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.status-header h2 {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
}

.status-dropdown {
  position: relative;
  display: inline-block;
}

.current-status {
  padding: 6px 16px;
  border-radius: 20px;
  background-color: #D6E6D3;
  color: #2B6629;
  font-weight: 500;
  font-size: 14px;
  cursor: pointer;
  user-select: none;
}

.current-status.accepted {
  background-color: #C6E8C2;
  color: #247626;
}

.status-list {
  position: absolute;
  top: 120%;
  right: 0;
  background-color: #fff;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 8px 0;
  margin: 4px 0 0 0;
  list-style: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  display: none;
  z-index: 10;
}

.status-dropdown:hover .status-list {
  display: block;
}

.status-item {
  padding: 6px 16px;
  font-size: 14px;
  cursor: pointer;
}

.status-item:hover {
  background-color: #f2f2f2;
}

.status-item.selected {
  background-color: #e7f6e6;
  color: #2B6629;
  font-weight: bold;
}.status-wrapper h2 {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
}

.status-select {
  position: relative;
}



.status-options {
  position: absolute;
  right: 0;
  top: 110%;
  width: 180px;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
  display: none;
  flex-direction: column;
  padding: 4px 0;
  z-index: 10;
}

.status-select:hover .status-options {
  display: flex;
}

.option {
  padding: 10px 16px;
  font-size: 14px;
  text-align: left;
  cursor: pointer;
  transition: background 0.2s ease;
}

.option:hover {
  background-color: #f5f5f5;
}

.option.selected {
  background-color: #e9f5e8;
  color: #2a6529;
  font-weight: 600;
}
button.status-button {
    background: #FFFFFF 0% 0% no-repeat padding-box;
    border: 1px solid #BF0404;
    border-radius: 5px;
    padding: 5px 45px;
    font-weight: 600;
}


.grid-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: auto auto;
      gap: 24px;
    }

    .box {
      background-color: #ffffff;
      padding: 20px 24px;
      border-radius: 12px;
      box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.06);
      cursor: grab;
    }

    .box:active {
      cursor: grabbing;
    }

  .box h3 {
   font-size: 21px;
    margin-bottom: 14px;
    font-weight: 600;
    border-bottom: 1px solid #eee;
    padding-bottom: 6px;
    box-shadow: 0px 5px 16px #00000012;
    margin-left: -23px;
    margin-right: -22px;
    margin-top: -19px;
    padding: 17px 15px;
}

.card.full-width {
    margin-top: 20px;
}
   .box ul
 {
    list-style: none;
    padding: 0;
    margin: 0;
    margin-top: 32px;
}

    .box ul li {
      margin-bottom: 10px;
      font-size: 14px;
    }

.badge.enabled {
    background-color: #A6A485;
    color: white;
    padding: 7px 15px;
    border-radius: 12px;
    font-size: 13px;
    display: inline-block;
}

    .pdf-icon {
      width: 18px;
      vertical-align: middle;
      margin: 0 5px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .grid-container {
        grid-template-columns: 1fr;
      }
    }

    .styled-list {
  list-style: none;
  padding: 0;
  margin: 0;
  border: 1px solid #dedcc9;
  border-radius: 10px;
  overflow: hidden;
  background-color: #fff;
  font-family: 'Poppins', sans-serif;
  font-size: 14px;
}

.styled-list li {
  padding: 10px 16px;
  border-bottom: 1px solid #dedcc9;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #333;
}

.styled-list li:last-child {
  border-bottom: none;
}

.styled-list strong {
  font-weight: 600;
  color: #6E6D55;
  min-width: 160px;
  display: inline-block;
}
.box ul li {
    display: flex
;
    align-items: center;
    gap: 20px;
    font-size: 14px;
    padding: 10px 0;
    border-bottom: 1px solid #dedcc9;
    font-weight: 600;
}

.box ul li:last-child {
  border-bottom: none;
}

.box ul li strong {
  min-width: 180px;
  font-weight: 600;
  color:#6E6D55;
  flex-shrink: 0;
}

.box ul li span {
  color: #333;
}
.parcours-table th {
    background-color : #ECEBE3;
    font-weight: 700;
}

.parcours-table th, .parcours-table td {
    border: 1px solid #ddd;
    padding: 8px;
    font-size: 14px;
    text-align: center;
}
.parcours-table .notes-cell {
  text-align: left;
  font-size: 13px;
  line-height: 1.4;
  font-family: 'Poppins', sans-serif;
  color: #333;
  white-space: nowrap;
}

</style>
<script>
  document.addEventListener('DOMContentLoaded', () => {
  const dropdown = document.querySelector('.dropdown');
  dropdown.addEventListener('click', () => {
    alert("Changer le statut ici...");
  });
});




 const dragZone = document.getElementById('dragZone');
  let draggedItem = null;

  dragZone.addEventListener('dragstart', function (e) {
    draggedItem = e.target;
    e.target.style.opacity = '0.5';
  });

  dragZone.addEventListener('dragend', function (e) {
    e.target.style.opacity = '1';
  });

  dragZone.addEventListener('dragover', function (e) {
    e.preventDefault();
  });

  dragZone.addEventListener('drop', function (e) {
    e.preventDefault();
    const target = e.target.closest('.box');
    if (target && draggedItem !== target) {
      const allBoxes = [...dragZone.querySelectorAll('.box')];
      const draggedIndex = allBoxes.indexOf(draggedItem);
      const targetIndex = allBoxes.indexOf(target);

      if (draggedIndex < targetIndex) {
        target.after(draggedItem);
      } else {
        target.before(draggedItem);
      }
    }
  });

  
</script>

<script>

/*
document.addEventListener('DOMContentLoaded', () => {
  fetch(PMSettings.apiUrlCandidatures, {
    method: 'GET',
    credentials: 'include',
    headers: {
      'X-WP-Nonce': PMSettings.nonce
    }
  })
  .then(response => response.json())
  .then(result => {
    if (result.status === 'success' && result.data.length > 0) {
      const c = result.data[0]; // on prend la premi√®re candidature

      const dragZone = document.getElementById('dragZone');
      dragZone.innerHTML = `
        <div class="box" draggable="true">
          <h3>Informations g√©n√©rales</h3>
          <ul>
            <li><strong>CIN :</strong> <span>${c.matricule}</span></li>
            <li><strong>Nom et pr√©nom :</strong> <span>${c.etudiant}</span></li>
            <li><strong>E-mail :</strong> <span>${c.email || '‚Äî'}</span></li>
            <li><strong>Sexe :</strong> <span>${c.sexe || '‚Äî'}</span></li>
            <li><strong>Situation :</strong> <span>${c.statut_etudiant}</span></li>
            <li><strong>Derni√®re connexion :</strong> <span>${c.last_login || '‚Äî'}</span></li>
            <li><strong>Enabled :</strong> <span class="badge enabled">Oui</span></li>
          </ul>
        </div>

        <div class="box" draggable="true">
          <h3>Bac</h3>
          <ul>
            <li><strong>Session :</strong> <span>${c.session || '‚Äî'}</span></li>
            <li><strong>Ann√©e :</strong> <span>${c.annee_bac || '‚Äî'}</span></li>
            <li><strong>Mention :</strong> <span>${c.mention || '‚Äî'}</span></li>
            <li><strong>Moyenne :</strong> <span>${c.moyenne || '‚Äî'}</span></li>
            <li><strong>Dipl√¥me :</strong>
              <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/PDF_file_icon.svg" class="pdf-icon" />
              <span>Relev√© des notes</span>
              <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/PDF_file_icon.svg" class="pdf-icon" />
            </li>
          </ul>
        </div>

        <div class="box" draggable="true">
          <h3>Adresse</h3>
          <ul>
            <li><strong>Pays :</strong> <span>${c.pays || 'Tunisie'}</span></li>
            <li><strong>Gouvernorat :</strong> <span>${c.gouvernorat || '‚Äî'}</span></li>
            <li><strong>Ville :</strong> <span>${c.ville || '‚Äî'}</span></li>
            <li><strong>Rue :</strong> <span>${c.rue || '‚Äî'}</span></li>
            <li><strong>Code postale :</strong> <span>${c.code_postal || '‚Äî'}</span></li>
          </ul>
        </div>

        <div class="box" draggable="true">
          <h3>Liste des masters en cours</h3>
          <ul>
            <li><strong>Master :</strong> <span>${c.master}</span></li>
            <li><strong>√âtablissement :</strong> <span>${c.etablissement || '‚Äî'}</span></li>
            <li><strong>Score :</strong> <span>${c.score ?? '‚Äî'}</span></li>
            <li><strong>Statut dossier :</strong> <span>${c.statut_dossier}</span></li>
            <li><strong>√âtat de validation :</strong> <span>${c.validation || '_'}</span></li>
            <li><strong>Statut :</strong> <span>${c.statut_final || 'Admis'}</span></li>
          </ul>
        </div>
      `;
    } else {
      console.warn('Aucune candidature trouv√©e.');
    }
  })
  .catch(error => {
    console.error('Erreur de chargement des candidatures :', error);
  });


  // get statuts de dossier : 

  fetch('/wp-json/plateforme-master/v1/statuts-dossier')
  .then(res => res.json())
  .then(result => {
    if (result.status === 'success' && Array.isArray(result.data)) {
      const container = document.querySelector('#status-select-dossier .status-options');
      container.innerHTML = '';

      // üîπ Option par d√©faut
      const defaultOption = document.createElement('div');
      defaultOption.className = 'option disabled';
      defaultOption.style.fontStyle = 'italic';
      container.appendChild(defaultOption);

      // üîπ Options r√©elles depuis l‚ÄôAPI
      result.data.forEach(stat => {
        const div = document.createElement('div');
        div.className = 'option';
        div.textContent = stat.libelle;
        container.appendChild(div);
      });
    }
  })
  .catch(err => {
    console.error('Erreur lors du chargement des statuts :', err);
  });


});

*/

document.addEventListener('DOMContentLoaded', () => {
  // üîπ Chargement de la candidature
 const urlParams = new URLSearchParams(window.location.search);
  const candidatureId = urlParams.get('id');

  if (!candidatureId) {
    console.warn('Aucun ID de candidature trouv√© dans l‚ÄôURL.');
    return;
  }

  // üîπ Chargement de la fiche candidature
  fetch(`${PMSettings.apiUrlDossierCandidature}/${candidatureId}`, {
    method: 'GET',
    credentials: 'include',
    headers: {
      'X-WP-Nonce': PMSettings.nonce
    }
  })
    .then(response => response.json())
    .then(result => {
      if (result.status === 'success') {
        const c = result.data.candidature;
        const statutActuel = c.statut_dossier;


        const bac = result.data.situation_academique?.[0] || {};

       const basePath = "/wp-content/uploads/candidats/";

      const bacBlock = `
        <div class="box" draggable="true">
          <h3>Bac</h3>
          <ul>
            <li><strong>Session :</strong> <span>${bac.session || '‚Äî'}</span></li>
            <li><strong>Ann√©e :</strong> <span>${bac.annee_academique || '‚Äî'}</span></li>
            <li><strong>Mention :</strong> <span>${bac.mention || '‚Äî'}</span></li>
            <li><strong>Moyenne :</strong> <span>${bac.moyenne || '‚Äî'}</span></li>
            <li><strong>Dipl√¥me :</strong> ${
              bac.piece_jointe_path
                ? `<a href="${basePath + bac.piece_jointe_path.split('/').pop()}" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/PDF_file_icon.svg" alt="PDF" class="pdf-icon">
                  </a>`
                : '<span>‚Äî</span>'
            }</li>
          </ul>
        </div>
      `;


        const adresse = result.data.adresse || {};

      const adresseBlock = `
        <div class="box" draggable="true">
          <h3>Adresse</h3>
          <ul>
            <li><strong>Pays :</strong> <span>Tunisie</span></li>
            <li><strong>Gouvernorat :</strong> <span>${adresse.gouvernorat_fr || '‚Äî'}</span></li>
            <li><strong>Ville (d√©l√©gation) :</strong> <span>${adresse.delegation_fr || '‚Äî'}</span></li>
            <li><strong>Adresse (Rue) :</strong> <span>${adresse.adresse_fr || '‚Äî'}</span></li>
            <li><strong>Code postale :</strong> <span>${adresse.code_postal || '‚Äî'}</span></li>
          </ul>
        </div>
      `;

      const criteres = result.data.criteres_score || [];
        let criteresBlock = '';

        if (criteres.length > 0) {
          let rows = '';

          criteres.forEach(crit => {
            rows += `<li><strong>${crit.label} :</strong> <span>${crit.valeur}</span></li>`;
          });

          criteresBlock = `
            <div class="box" draggable="true">
              <h3>Crit√®res de score</h3>
              <ul>
                ${rows}
              </ul>
            </div>
          `;
        }


        const dragZone = document.getElementById('dragZone');
        dragZone.innerHTML = `
          <div class="box" draggable="true">
            <h3>Informations g√©n√©rales</h3>
            <ul>
              <li><strong>CIN :</strong> <span>${c.cin}</span></li>
              <li><strong>Nom et pr√©nom :</strong> <span>${c.nom} ${c.prenom}</span></li>
              <li><strong>E-mail :</strong> <span>${c.email1 || '‚Äî'}</span></li>
              <li><strong>T√©l√©phone :</strong> <span>${c.telephone || '‚Äî'}</span></li>
              <li><strong>Situation :</strong> <span>${c.statut_etudiant}</span></li>
              <li><strong>Date de soumission :</strong> <span>${c.date_soumission || '‚Äî'}</span></li>
            </ul>
          </div>

          <div class="box" draggable="true">
            <h3>Master</h3>
            <ul>
              <li><strong>Intitul√© :</strong> <span>${c.intitule_master}</span></li>
              <li><strong>Niveau :</strong> <span>${c.niveau}</span></li>
              <li><strong>Ann√©e universitaire :</strong> <span>${c.annee_universitaire}</span></li>
              <li><strong>Score :</strong> <span>${c.score ?? '‚Äî'}</span></li>
              <li><strong>Statut dossier :</strong> <span>${result.data.statut_libelle}</span></li>
            </ul>
          </div>

            ${bacBlock}


         ${adresseBlock}
           ${criteresBlock}


        `;


        const parcours = result.data.parcours || [];
          const tbody = document.getElementById('parcoursTbody');
          tbody.innerHTML = ''; // vide d'abord le contenu

          if (parcours.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9">Aucun parcours enregistr√©.</td></tr>';
          } else {

            
          const basePath = "/wp-content/uploads/candidats/";

          parcours.forEach(p => {
            const niveau = getNiveauParCycleEtAnnee(p.cycle, p.annee_academique);

            const fileAttestation = p.piece_jointe_path_attestation
              ? `${basePath}${p.piece_jointe_path_attestation.split('/').pop()}`
              : null;

            const fileReleve = p.piece_jointe_path_releve
              ? `${basePath}${p.piece_jointe_path_releve.split('/').pop()}`
              : null;

            const row = `
              <tr>
                <td>${p.annee_academique || '‚Äî'}</td>
                <td>${p.nom_universite || '‚Äî'}</td>                  
                <td>${p.nom_etablissement || '‚Äî'}</td>
                <td>${p.session || '‚Äî'}</td>
                <td>${niveau}</td>
                <td>${p.mention || '‚Äî'}</td>
                <td>${p.moyenne || '‚Äî'}</td>
                <td>${p.credit || '‚Äî'}</td>

                <td>${
                  fileAttestation
                    ? `<a href="${fileAttestation}" target="_blank">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/PDF_file_icon.svg" class="pdf-icon">
                      </a>`
                    : '‚Äî'
                }</td>
                <td>${
                  fileReleve
                    ? `<a href="${fileReleve}" target="_blank">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/PDF_file_icon.svg" class="pdf-icon">
                      </a>`
                    : '‚Äî'
                }</td>
              </tr>
            `;

            tbody.insertAdjacentHTML('beforeend', row);
          });


          }

        
   // Attendre que les statuts soient charg√©s (petit d√©lai)
        setTimeout(() => {
          const currentStatut = statutActuel?.toLowerCase().trim();
          const options = document.querySelectorAll('#status-select-dossier .status-options .option:not(.disabled)');
          const button = document.querySelector('#status-select-dossier .status-button');

          let statutTrouve = false;

          options.forEach(opt => {
            const optionText = opt.textContent.toLowerCase().trim();

            if (optionText === currentStatut) {
              opt.classList.add('selected');
              button.textContent = opt.textContent;
              statutTrouve = true;
            }
          });

          if (!statutTrouve) {
            button.textContent = "Statut dossier";
          }

        }, 500);

      } else {
        console.warn('Candidature introuvable.');
      }
     


    })
    .catch(error => {
      console.error('Erreur de chargement de la fiche candidature :', error);
    });

  // üîπ Chargement des statuts disponibles
  fetch('/wp-json/plateforme-master/v1/statuts-dossier')
    .then(res => res.json())
    .then(result => {
      if (result.status === 'success' && Array.isArray(result.data)) {
        const container = document.querySelector('#status-select-dossier .status-options');
        container.innerHTML = '';

        // Option par d√©faut
        const defaultOption = document.createElement('div');
        defaultOption.className = 'option disabled';
        defaultOption.style.fontStyle = 'italic';
        container.appendChild(defaultOption);

        // Statuts r√©els
        result.data.forEach(stat => {
          const div = document.createElement('div');
          div.className = 'option';
          div.textContent = stat.libelle;
          container.appendChild(div);
        });
      }
    })
    .catch(err => {
      console.error('Erreur lors du chargement des statuts :', err);
    });
});


function getNiveauParCycleEtAnnee(cycle, anneeAcademique) {
  const annee = parseInt(anneeAcademique);
  if (!cycle || isNaN(annee)) return '‚Äî';

  cycle = cycle.toLowerCase();

  if (cycle.includes('licence')) {
    return annee >= 1 && annee <= 3 ? `L${annee}` : '‚Äî';
  }

  if (cycle.includes('maitrise') || cycle.includes('ma√Ætrise')) {
    return annee >= 1 && annee <= 4 ? `L${annee}` : '‚Äî';
  }

  if (cycle.includes('mast√®re') || cycle.includes('master')) {
    if (annee >= 1 && annee <= 3) return `L${annee}`; // pr√©-M1
    if (annee === 4) return 'M1';
    if (annee === 5) return 'M2';
    return '‚Äî';
  }

  if (cycle.includes('ingenieur') || cycle.includes('ing√©nieur')) {
    return annee >= 1 && annee <= 5 ? `I${annee}` : '‚Äî';
  }

  return '‚Äî';
}

document.addEventListener('DOMContentLoaded', () => {
  const candidatureId = new URLSearchParams(window.location.search).get('id');

  if (!candidatureId) {
    alert("‚ùå ID de candidature introuvable dans l'URL.");
    return;
  }

  // D√©l√©gation d'√©v√©nement : capter les clics sur le conteneur
  document.querySelector('#status-select-dossier .status-options')
    .addEventListener('click', function (e) {
      const option = e.target.closest('.option');

      if (!option || option.classList.contains('disabled')) return;

      const statutCode = option.dataset.code;
      const statutLabel = option.textContent;

      if (!statutLabel) {
        alert("‚ùå Code de statut manquant.");
        return;
      }

      const confirmed = confirm(`Confirmez-vous le changement du statut en : "${statutLabel}" ?`);

      if (!confirmed) return;

      fetch('/wp-json/plateforme-master/v1/modifier-statut-dossier', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-WP-Nonce': PMSettings.nonce
        },
        body: JSON.stringify({
          candidature_id: parseInt(candidatureId),
          statut_dossier: statutLabel
        })
      })
        .then(res => res.json())
        .then(response => {
          if (response.success) {
            alert("‚úÖ Statut mis √† jour avec succ√®s !");
            document.querySelector('.status-button').textContent = statutLabel;
          } else {
            alert("‚ùå √âchec de la mise √† jour du statut.");
          }
        })
        .catch(err => {
          console.error("Erreur API :", err);
          alert("‚ùå Erreur r√©seau. Veuillez r√©essayer.");
        });
    });
});


</script>
